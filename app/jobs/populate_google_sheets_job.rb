class PopulateGoogleSheetsJob < ApplicationJob
  include Rails.application.routes.url_helpers
  queue_as :default

  def perform(**args)
    file_id     = Setting.pluck(:var, :value).to_h["tid_#{args[:site]}"]
    games       = Game.order(:top)

    session     = GoogleDrive::Session.from_service_account_key('key.json')
    spreadsheet = session.file_by_id(file_id)
    worksheet   = spreadsheet.worksheets.first

    idx = 2
    games.each_slice(100) do |games_slice |
      games_slice.each do |game|
        worksheet[idx, 7]  = game.sony_id
        worksheet[idx, 12] = make_name(game)
        worksheet[idx, 13] = description(game, args[:site])
        worksheet[idx, 14] = game.price
        worksheet[idx, 15] = make_image(game, args[:site])
        idx += 1
      end
      worksheet.save
    end
    nil
  rescue => e
    TelegramService.new("Error #{self.class} || #{e.message}").report
    raise
  end

  private

  def make_name(game)
    raw_name = game.name
    platform  = game.platform

    if platform == 'PS5, PS4' || platform.match?(/PS4/) #ps4, ps5
      prefix = '(PS5 and PS4)'
      if raw_name.downcase.match?(/ps4/)
        if raw_name.downcase.match?(/ps5/)
          raw_name
        else
          raw_name.sub('(PS4)', '').sub('PS4', '') + prefix
        end
      else
        if raw_name.downcase.match?(/ps5/)
          raw_name.sub('(PS5)', '').sub('PS5', '') + prefix
        else
          raw_name + prefix
        end
      end
    else #ps5
      if raw_name.downcase.match?(/ps5/)
        raw_name
      else
        raw_name + '(PS5)'
      end
    end
  end

  def make_image(game, site)
    if game.images.attached? && game.images.blobs.any? { |i| i.metadata[:site] == site }
      image = game.images.find { |i| i.blob.metadata[:site] == site }
      rails_blob_url(image, host: 'server.open-ps.ru')
    else
      nil
    end
  end

  def description(game, site)
    method_name = "desc_#{site}".to_sym
    send(method_name, game)
  end

  def desc_open_ps(game)
    <<~DESCR
      <p><strong>–ò–≥—Ä–∞ –¥–ª—è Playstation #{game.name}</strong></p>

      <ul>
          <li>–†—É—Å—Å–∫–∞—è –≥–æ–ª–æ—Å: #{game.rus_voice ? '–ï—Å—Ç—å' : '–ù–µ—Ç'}</li>
          <li>–†—É—Å—Å–∫–æ–µ –º–µ–Ω—é –∏ —Ç–µ–∫—Å—Ç: #{game.rus_screen ? '–ï—Å—Ç—å' : '–ù–µ—Ç'}</li>
      </ul>

      <p>–ü—Ä–∏—Å—Ç–∞–≤–∫–∞: #{game.platform}</p>
      <p>–ú–∞—Ä—Ç–æ–≤—Å–∫–∞—è —Ä–∞—Å–ø—Ä–æ–¥–∞–∂–∞, —Å–∫–∏–¥–∫–∏ –¥–æ 70%!</p>
      <p>–ù–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è <strong>Open-Ps</strong> –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –ø—Ä–æ–¥–∞–∂–µ–π –∏–≥—Ä –±–æ–ª–µ–µ —Ç—Ä–µ—Ö –ª–µ—Ç –∏ —É –Ω–∞—Å –±–æ–ª–µ–µ 5000 –æ—Ç–∑—ã–≤–æ–≤!</p>
      <p>–ú—ã –Ω–∞ —Å–≤—è–∑–∏ 24 —á–∞—Å–∞ –≤ —Å—É—Ç–∫–∏, –ø–∏—à–∏—Ç–µ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è!</p>
      <ul>
          <li>üí£ –°–∞–º—ã–µ –Ω–∏–∑–∫–∏–µ —Ü–µ–Ω—ã, –µ—Å–ª–∏ –Ω–∞–π–¥–µ—Ç–µ –¥–µ—à–µ–≤–ª–µ - –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º.</li>
          <li>üí£ –ò–≥—Ä–∞ —Ç–æ–ª—å–∫–æ –í–∞—à–∞ –∏ –æ—Å—Ç–∞–µ—Ç—Å—è —É –í–∞—Å –Ω–∞–≤—Å–µ–≥–¥–∞, –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏ —Å–∫–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.</li>
          <li>üí£ –ù–µ –Ω—É–∂–Ω–æ –Ω–∏–∫—É–¥–∞ –µ—Ö–∞—Ç—å –∏ –∂–¥–∞—Ç—å, –≤—Å–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω–æ, –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–Ω–∏–º–∞–µ—Ç 5 –º–∏–Ω—É—Ç.</li>
          <li>üí£ –£ –Ω–∞c –í—ã c–º–æ–∂–µ—Çe –ø—Ä–∏o–±p–µc—Ç–∏ –õ–Æ–ë–£–Æ –∏–≥—Ä—É/–ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –†S4/PS5.</li>
      </ul>
      <p>–ü–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –Ω–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å–∞–º—ã–µ –±–æ–ª—å—à–∏–µ —Å–∫–∏–¥–∫–∏.</p>
      <p>–¢–µ–≥–∏: —Äl–∞yst–∞ti–æn —Älus, —Äs+, —Äs —Älus, –ü–æ–¥–ø–∏—Å–∫–∞ –†SN, –ü–æ–¥–ø–∏—Å–∫–∞, –†l–∞yst–∞ti–æn 12 –º–µ—Å—è—Ü–µ–≤, –ø–æ–¥–ø–∏—Å–∫–∞ —Äs —Älus, 
      –ø–æ–¥–ø–∏—Å–∫–∞ —Äs, —Äl–∞yst–∞ti–æn+, —Äs+, —Äs+ 12 –º–µ—Å—è—Ü–µ–≤, –ø–æ–¥–ø–∏—Å–∫–∞ —Äs —Älus, —Äs st–ær–µ, —Äl–∞y, –ø—Å–Ω –¢—É—Ä—Ü–∏—è, st–∞ti–æn st–ær–µ, 
      –∏–≥—Ä—ã –¥–ª—è —Äs4, —Äs4, —Äs5, 4, 5, –∏–≥—Ä–∞ –¥–ª—è –ø—Ä–∏—Å—Ç–∞–≤–∫–∏, –ø–æ–¥–ø–∏—Å–∫–∞, –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≥–æ–¥, –º–µ—Å—è—Ü, –ø–æ–¥–ø–∏—Å–∫–∞ –µ—Ötr–∞, –ø–æ–¥–ø–∏—Å–∫–∞ 
      d–µlu—Ö–µ, –≠–∫—Å—Ç—Ä–∞, –î–µ–ª—é–∫—Å, Essential, Extra, Ea Play pro</p>
    DESCR
  end

  def desc_open_ps_store(game)
    <<~DESCR
      <p>–ò–≥—Ä–∞ #{game.name}</p>
  
      <p>–†—É—Å—Å–∫–∞—è –æ–∑–≤—É—á–∫–∞: #{game.rus_voice ? '–ï—Å—Ç—å' : '–ù–µ—Ç'}</p>
      <p>–†—É—Å—Å–∫–∞—è —Å—É–±—Ç–∏—Ç—Ä—ã: #{game.rus_screen ? '–ï—Å—Ç—å' : '–ù–µ—Ç'}</p> 
      
      –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: #{game.platform}
  
      –¶–µ–Ω–∞ —É–∫–∞–∑–∞–Ω–∞ —Å —É—á–µ—Ç–æ–º —Ñ–µ–≤—Ä–∞–ª—å—Å–∫–æ–π –∞–∫—Ü–∏–∏! –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–æ 31 –º–∞—Ä—Ç–∞!
      –ù–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ ¬´OPEN PS STORE¬ª –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –∏–≥—Ä –∏ –ø–æ–¥–ø–∏—Å–æ–∫ –±–æ–ª–µ–µ 3-—Ö –ª–µ—Ç.
      –†–∞–±–æ—Ç–∞–µ–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å —Å 09:00 –¥–æ 23:30 –ø–æ –ú–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏.

      ‚≠êÔ∏è –ë—ã—Å—Ç—Ä–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ, –æ—Ç 3 –º–∏–Ω—É—Ç
      ‚≠êÔ∏è –ë–æ–ª–µ–µ 3000 –æ—Ç–∑—ã–≤–æ–≤
      ‚≠êÔ∏è –ì–∞—Ä–∞–Ω—Ç–∏—è –æ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
      
      –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –∏ –º—ã –æ—Ñ–æ—Ä–º–∏–º –í–∞–º –∏–≥—Ä—É –Ω–∞ –≤–∞—à—É –ø—Ä–∏—Å—Ç–∞–≤–∫—É, –≤—Å–µ —á—Ç–æ –í–∞–º –æ—Å—Ç–∞–Ω–µ—Ç—Å—è - —ç—Ç–æ —Å–∫–∞—á–∞—Ç—å –∏–≥—Ä—É –∏ –Ω–∞—Å–ª–∞–¥–∏—Ç—å—Å—è –ø—Ä–æ—Ü–µ—Å—Å–æ–º.
      
      –ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –Ω–∞—à –ø—Ä–æ—Ñ–∏–ª—å, —Ç–∞–º –≤—ã —Å–º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –º–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –∏–≥—Ä –ø–æ —Å–∞–º—ã–º –Ω–∏–∑–∫–∏–º —Ü–µ–Ω–∞–º
      
      –¢–µ–≥–∏: —Äl–∞yst–∞ti–æn —Älus, —Äs+, —Äs —Älus, –ü–æ–¥–ø–∏—Å–∫–∞ –†SN, –ü–æ–¥–ø–∏—Å–∫–∞, –†l–∞yst–∞ti–æn 12 –º–µ—Å—è—Ü–µ–≤, –ø–æ–¥–ø–∏—Å–∫–∞ —Äs —Älus, –ø–æ–¥–ø–∏—Å–∫–∞ —Äs, —Äl–∞yst–∞ti–æn+, —Äs+, —Äs+ 12 –º–µ—Å—è—Ü–µ–≤, –ø–æ–¥–ø–∏—Å–∫–∞ —Äs —Älus, —Äs st–ær–µ, —Äl–∞y, –ø—Å–Ω –¢—É—Ä—Ü–∏—è, st–∞ti–æn st–ær–µ, –∏–≥—Ä—ã –¥–ª—è —Äs4, —Äs4, —Äs5, 4, 5, –∏–≥—Ä–∞ –¥–ª—è –ø—Ä–∏—Å—Ç–∞–≤–∫–∏, –ø–æ–¥–ø–∏—Å–∫–∞, –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≥–æ–¥, –º–µ—Å—è—Ü, –ø–æ–¥–ø–∏—Å–∫–∞ –µ—Ötr–∞, –ø–æ–¥–ø–∏—Å–∫–∞ d–µlu—Ö–µ, –≠–∫—Å—Ç—Ä–∞, –î–µ–ª—é–∫—Å, Essential, Extra, Ea Play pro
    DESCR
  end

  def desc_alexander(game)
    <<~DESCR
      <p><strong>#{game.name} –∏–≥—Ä–∞ –¥–ª—è Playstation, (–Ω–µ –¥–∏—Å–∫)</strong></p>

      <p>–†—É—Å—Å–∫–∞—è –æ–∑–≤—É—á–∫–∞: #{game.rus_voice ? '–ï—Å—Ç—å' : '–ù–µ—Ç'}</p>
      <p>–†—É—Å—Å–∫–∞—è —Å—É–±—Ç–∏—Ç—Ä—ã: #{game.rus_screen ? '–ï—Å—Ç—å' : '–ù–µ—Ç'}</p>    

      <p>–ù–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ <strong>Open-PS</strong> –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –∏–≥—Ä –∏ –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è Playstation —Å 2021 –≥–æ–¥–∞.</p>
      <ul>
          <li>üî• –ú—ã –º–æ–∂–µ–º –æ—Ñ–æ—Ä–º–∏—Ç—å –õ–Æ–ë–£–Æ –∏–≥—Ä—É / –ø–æ–¥–ø–∏—Å–∫—É / –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –∏–≥—Ä—ã / –¥–æ–Ω–∞—Ç –¥–ª—è PS4 –∏ PS5</li>
          <li>üî• –í—ã –Ω–∞—à–ª–∏ –∏–≥—Ä—É –¥–µ—à–µ–≤–ª–µ? –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –∏ –º—ã —Å–¥–µ–ª–∞–µ–º –í–∞–º —Å–∫–∏–¥–∫—É.</li>
          <li>üî• –ë—ã—Å—Ç—Ä–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ (–æ—Ç 5 –º–∏–Ω—É—Ç)</li>
          <li>üî• –ë–æ–ª–µ–µ 5000 –æ—Ç–∑—ã–≤–æ–≤</li>
          <li>üî• –†–∞–±–æ—Ç–∞–µ–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å —Å 09:00 –¥–æ 23:40 –ø–æ –ú–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏</li>
      </ul>
      <p>–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –∏ –±—ã—Ç—å –≤ –∫—É—Ä—Å–µ –≤—Å–µ—Ö —Ä–∞—Å–ø—Ä–æ–¥–∞–∂.</p>
      <p>–¢–µ–≥–∏: —Äl–∞yst–∞ti–æn —Älus, —Äs+, —Äs —Älus, –ü–æ–¥–ø–∏—Å–∫–∞ –†SN, –ü–æ–¥–ø–∏—Å–∫–∞, –†l–∞yst–∞ti–æn 12 –º–µ—Å—è—Ü–µ–≤, –ø–æ–¥–ø–∏—Å–∫–∞ —Äs —Älus, –ø–æ–¥–ø–∏—Å–∫–∞ 
      —Äs, —Äl–∞yst–∞ti–æn+, —Äs+, —Äs+ 12 –º–µ—Å—è—Ü–µ–≤, –ø–æ–¥–ø–∏—Å–∫–∞ —Äs —Älus, —Äs st–ær–µ, —Äl–∞y, –ø—Å–Ω –¢—É—Ä—Ü–∏—è, st–∞ti–æn st–ær–µ, –∏–≥—Ä—ã –¥–ª—è —Äs4, 
      —Äs4, —Äs5, 4, 5, –∏–≥—Ä–∞ –¥–ª—è –ø—Ä–∏—Å—Ç–∞–≤–∫–∏, –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≥–æ–¥, –º–µ—Å—è—Ü, –ø–æ–¥–ø–∏—Å–∫–∞ –µ—Ötr–∞, –ø–æ–¥–ø–∏—Å–∫–∞ d–µlu—Ö–µ, –≠–∫—Å—Ç—Ä–∞, –î–µ–ª—é–∫—Å, 
      Essential, Extra, Ea Play pro</p>
    DESCR
  end
end
